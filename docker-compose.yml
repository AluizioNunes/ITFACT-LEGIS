name: legis

services:
  # PostgreSQL + pgvector (vector similarity search)
  postgres:
    image: pgvector/pgvector:pg17
    container_name: LEGIS-POSTGRESQL
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-itfact_legis}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres123}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - legis-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis (Latest)
  redis:
    image: redis:latest
    container_name: LEGIS-REDIS
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - legis-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MongoDB
  mongodb:
    image: mongo:latest
    container_name: LEGIS-MONGODB
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USER:-LEGIS}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-LEGIS}
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    networks:
      - legis-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  # Neo4j Graph Database
  neo4j:
    image: neo4j:latest
    container_name: LEGIS-NEO4J
    environment:
      NEO4J_AUTH: ${NEO4J_USER}/${NEO4J_PASSWORD}
      NEO4J_PLUGINS: '["apoc", "graph-data-science"]'
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    networks:
      - legis-network
    healthcheck:
      test: ["CMD-SHELL", "cypher-shell -u ${NEO4J_USER} -p ${NEO4J_PASSWORD} 'RETURN 1'"]
      interval: 10s
      timeout: 5s
      retries: 5

  # RabbitMQ Message Broker
  rabbitmq:
    image: rabbitmq:latest
    container_name: LEGIS-RABBITMQ
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-LEGIS}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASS:-LEGIS}
    ports:
      - "5672:5672"   # AMQP
      - "15672:15672" # Management UI
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - legis-network
    healthcheck:
      test: rabbitmq-diagnostics -q ping
      interval: 10s
      timeout: 5s
      retries: 5

  # MinIO (S3-compatible object storage)
  minio:
    image: minio/minio:latest
    container_name: LEGIS-MINIO
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    ports:
      - "9000:9000"  # API
      - "9001:9001"  # Console
    volumes:
      - minio_data:/data
    networks:
      - legis-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 5

  # NestJS Backend
  nestjs:
    build:
      context: ./Backend/NestJS
      dockerfile: Dockerfile
    container_name: LEGIS-NESTJS
    environment:
      NODE_ENV: ${NODE_ENV}
      DATABASE_URL: ${DOCKER_DATABASE_URL_NODE}
      REDIS_URL: ${DOCKER_REDIS_URL}
      RABBITMQ_URL: ${DOCKER_RABBITMQ_URL}
      JWT_SECRET: ${JWT_SECRET}
      PORT: ${PORT}
    ports:
      - "${PORT}:${PORT}"
    volumes:
      - ./Backend/NestJS:/app
      - /app/node_modules
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - legis-network
    command: npm run start:dev

  # FastAPI Backend (Python 3.14)
  fastapi:
    build:
      context: ./Backend/FastAPI
      dockerfile: Dockerfile
    container_name: LEGIS-FASTAPI
    environment:
      DATABASE_URL: ${DOCKER_DATABASE_URL_PYTHON}
      REDIS_URL: ${DOCKER_REDIS_URL}
      MONGODB_URL: ${DOCKER_MONGODB_URL}
      NEO4J_URI: ${DOCKER_NEO4J_URI}
      NEO4J_USER: ${NEO4J_USER}
      NEO4J_PASSWORD: ${NEO4J_PASSWORD}
      RABBITMQ_URL: ${DOCKER_RABBITMQ_URL}
      MINIO_ENDPOINT: ${MINIO_ENDPOINT}
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
    ports:
      - "${FASTAPI_PORT}:${FASTAPI_PORT}"
    volumes:
      - ./Backend/FastAPI:/app
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
      minio:
        condition: service_healthy
    networks:
      - legis-network
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload

  # Next.js Frontend
  frontend:
    build:
      context: ./
      dockerfile: Dockerfile
      target: development
    container_name: LEGIS-FRONTEND
    environment:
      NODE_ENV: ${NODE_ENV}
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
      NEXT_PUBLIC_WS_URL: ${NEXT_PUBLIC_WS_URL}
    ports:
      - "3000:3000"
    volumes:
      - ./:/app
      - /app/node_modules
      - /app/.next
      - /app/Backend
    depends_on:
      - nestjs
      - fastapi
    networks:
      - legis-network
    command: npm run dev

  # Nginx Reverse Proxy
  nginx:
    image: nginx:latest
    container_name: LEGIS-NGINX
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - frontend
      - nestjs
      - fastapi
    networks:
      - legis-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Prometheus (#14 Monitoring)
  prometheus:
    image: prom/prometheus:latest
    container_name: LEGIS-PROMETHEUS
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring:/etc/prometheus:ro
      - prometheus_data:/prometheus
    networks:
      - legis-network
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.retention.time=30d'

  # Grafana (#14 Monitoring)
  grafana:
    image: grafana/grafana:latest
    container_name: LEGIS-GRAFANA
    ports:
      - "3200:3000"
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-legis2026}
      GF_USERS_ALLOW_SIGN_UP: "false"
    volumes:
      - grafana_data:/var/lib/grafana
    depends_on:
      - prometheus
    networks:
      - legis-network

networks:
  legis-network:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  mongodb_data:
  neo4j_data:
  neo4j_logs:
  rabbitmq_data:
  minio_data:
  prometheus_data:
  grafana_data:

